<!doctype html>
<html>
  <head>
    <title>projects</title>
    <link rel='stylesheet' href='../static/css/bootstrap.min.css'>

    <style>
      #sidebar {
        margin: 30px 0 0 0;
      }

      #project-types li {
        margin: 0 0 0 5px;
        cursor: pointer;
        color: '#0069D6';
      }

      .project {
        margin: 0 0 25px 0;
      }

      .embedded-content {
        text-align: center;
        margin: 15px 0 15px 0;
      }

      .thumb-container {
        height: 150px;
      }

      .thumb {
        cursor: pointer;
      }

      .expanded-project {
        padding: 0 0 20px 0;
      }

      .close-button {
        cursor: pointer;
      }
    </style>
  </head>

  <body>
    <div class='container'>
      <div class='row'>
        <div class='span16'>
          <div class='row'>

            <div id='sidebar' class='span2'>
              <p><a href='../'>home</a></p>
              <p><a href='../about'>about</a></p>
              <p>projects</p>
              <ul id='project-types' class='unstyled'>
                <li class='project-filter filter-selected' id='all'>all&nbsp;<span class='filter-selected-chevron'>&raquo;</span></li>
                <li class='project-filter' id='large'>large&nbsp;<span style='display: none' class='filter-selected-chevron'>&raquo;</span></li>
                <li class='project-filter' id='small'>small&nbsp;<span style='display: none' class='filter-selected-chevron'>&raquo;</span></li>
                <li class='project-filter' id='favorite'>favorite&nbsp;<span style='display: none' class='filter-selected-chevron'>&raquo;</span></li>
              </ul>
            </div> <!--/sidebar-->

            <!--history appended here-->

          </div>
        </div>
      </div><!--/row-->
    </div><!--/container-->
  
    <script src='http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js'></script>
    <script>
      window.jQuery || document.write('<script src="../static/js/jquery-1.7.1.min.js">\x3C/script>')
    </script>
    <script src='../static/js/mustache.js'></script>
    <script src='../static/js/jquery.smooth-scroll.min.js'></script>
    <script src='../static/js/jquery.history.js'></script>

    <script src='projects.js'></script>

    <script>
      var project_list_template = 
          "<div id='history' class='span14'>"
            // iterate through the years
            + "{{#history}}"
            + "<div class='row year' id='{{year}}'>"
              + "<h2 class='year-label'>{{year}}</h2>"
              // iterate through the year's projects
              + "{{#projects}}"
              // each tag is added as a class for this project
              + "<div class='project span4{{#tags}} {{.}}{{/tags}}'>"
                + "<div class='thumb-container'>"
                  + "{{#photos}}<img class='thumb expando' src={{thumb}} />{{/photos}}"
                + "</div><!--/thumb-container-->"
                + "<strong class='title'>{{name}}</strong>"
                + "<p>{{blurb}}</p>"
              + "</div>"
              + "{{/projects}}"
            + "</div>"
            + "{{/history}}"
          +"</div><!--/content-->";
      
      var project_expanded_template = 
          "<div id='{{name}}' class='expanded-project span12{{#tags}} {{.}}{{/tags}}'>"
            + "<h3>{{name}} <small>{{where}}</small>"
              // set an onclick method here for removing the expanded project as it cannot be registered onload
              + "<span class='close-button pull-right' onclick='remove_expanded($(this).parent().parent())'>"
                + "&times;</span></h3>"
            + "{{#expound}}"
              + "{{{expound}}}"
            + "{{/expound}}"
            + "{{^expound}}"
              + "<i>still working on a full writeup - sorry!</i>"
            + "{{/expound}}"
          + "</div><!--/expanded-project-->";

        
      $(function() {
        // populate the page
        var html = Mustache.to_html(project_list_template, projects);
        $('#sidebar').parent().append(html);

        // check to see if a project is specified in the url parameters
        show_project_from_url();

        // initialize history manipulation
        var History = window.History;
        History.Adapter.bind(window, 'statechange', function() {
          show_project_from_url();
        });
        
        $('.expando').click(function() {
          /* an image is clicked and we need to show some more info on this page
          */
          year = $(this).parents('.year').attr('id');
          project_title = $(this).parent().siblings('.title').html();

          // update the history
          // replace any project_title parameter spaces with '+' signs
          // a 'statechange' event is bound to history - this displays the project
          History.pushState(
            null
            , project_title
            , '?y=' + year + '&p=' + project_title.replace(/\s+/g, '+')
          );
        });


        $('.project-filter').click(function() {
          /* project sidebar filtering which projects are displayed based on the 'tags'
          */
          var filter = $(this).attr('id');
          if (filter == 'all') {
            $('.project').css({visibility: 'visible'});
            $('.filter-selected-chevron').hide();
            $(this).children('.filter-selected-chevron').show();

          } else {  // could check to make sure the fiter's not alerady active but that caused some trouble with 'favorites'
            // show the relevant projects
            $('.project.' + filter).css({visibility: 'visible'});
            // hide all the ones that don't have this tag
            $('.project').not('.'+filter).css({visibility: 'hidden'});
            $('.expanded-project').not('.'+filter).remove();
            // move the selected class around
            $('.filter-selected').removeClass('filter-selected');
            $(this).addClass('filter-selected');
            $('.filter-selected-chevron').hide();
            $(this).children('.filter-selected-chevron').show();
          }
        });
        
      });
      
      
      function show_project_from_url() {
        var project_title = get_parameter_by_name('p').replace(/\/+/g, ''),
            year = get_parameter_by_name('y').replace(/\/+/g, '');

        // 'get_parameter_by_name' returns empty strings if param is not found
        if (project_title != '' && year != '') {
          var project = find_project(year, project_title);
          if (typeof project !== 'undefined') {
            // clear out any expanded projects from the same year
            $('#' + year).children('.expanded-project').remove();
            // show the target project
            show_project(year, project);
          }
          
        } else if (year != '') {
          // clear out any expanded projects from the same year
          $('#' + year).children('.expanded-project').remove();
          // try to scroll to this year
          $.smoothScroll({
            scrollTarget: $('#' + year)
            , speed: 500
          });
          
        } else {
          // no parameters specified, clear all displayed projects
          $('.expanded-project').remove();
          // scroll to top
          $.smoothScroll({
            offset: 0
            , speed: 500
          });
        }

      }

      function show_project(year, project) {
        /* prepend paragraphs about this project to the top of the year section
        then scroll to the year
        */
        var html = Mustache.to_html(project_expanded_template, project);
        $('#' + year).children('.year-label').after(html);
        
        $.smoothScroll({
          scrollTarget: $('#' + year)
          , speed: 500
        });
      }

      function find_project(year, project_title) {
        /* walk through the projects.js file, looking for the specified project
        first find the year
        */
        for (m in projects['history']) {
          if (projects['history'][m]['year'] == year) {
            // find the project 
            for (n in projects['history'][m]['projects']) {
              if (projects['history'][m]['projects'][n]['name'] == project_title) {

                return projects['history'][m]['projects'][n]
              }
            }
          }
        }
      }

      function remove_expanded(expanded_project) {
        /* clicking an expanded project's "x" sends the whole project as a jq object
        */
        var year = expanded_project.parents('.year').attr('id');
        // remove the project
        expanded_project.remove();
        
        // update the history
        History.pushState(null, 'projects', '/projects/?y=' + year);
      }
      
      function get_parameter_by_name(name) {
        /* getting URL parameters
        *  from Artem Barger at http://stackoverflow.com/questions/901115
        */
        name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
        var regexS = "[\\?&]"+name+"=([^&#]*)";
        var regex = new RegExp( regexS );
        var results = regex.exec( window.location.href );

        if( results == null )
          return "";
        else
          return decodeURIComponent(results[1].replace(/\+/g, " "));
      }

    </script>

  </body>
</html>
